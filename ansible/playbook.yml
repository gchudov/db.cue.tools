---
- name: Manage system setup
  hosts: localhost
  tasks:
    - name: Install Docker
      become: yes
      yum:
        name: docker
        state: present

    - name: Enable Docker service
      become: yes
      service:
        name: docker
        enabled: yes

    - name: Start Docker service
      become: yes
      service:
        name: docker
        state: started

    - name: Install tmux
      become: yes
      yum:
        name: tmux
        state: present

    - name: Check if Docker network 'ct' exists
      command: docker network inspect ct
      register: docker_network_check
      ignore_errors: yes

    - name: Create Docker network 'ct'
      command: docker network create ct
      when: docker_network_check.rc != 0

    - name: Download and install VS Code CLI for Amazon Graviton
      become: yes
      shell: |
        if [ ! -f /usr/local/bin/code ]; then
          curl -L --no-progress-meter "https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-arm64" -o /tmp/vscode-cli-alpine-arm64.tar.gz
          tar -xzf /tmp/vscode-cli-alpine-arm64.tar.gz -C /usr/local/bin
          rm /tmp/vscode-cli-alpine-arm64.tar.gz
        fi
      args:
        creates: /usr/local/bin/code
