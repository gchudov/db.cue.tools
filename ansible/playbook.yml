---
- name: Manage system setup
  hosts: localhost
  tasks:
    - name: Install Docker, pip, tmux and cronie (cron daemon)
      become: yes
      yum:
        name:
          - docker
          - pip
          - tmux
          - cronie
        state: present

    - name: Add ec2-user to docker group
      become: yes
      user:
        name: ec2-user
        groups: docker
        append: yes

    - name: Enable and startDocker service
      become: yes
      service:
        name: docker
        enabled: yes
        state: started

    - name: Enable and start crond service
      become: yes
      service:
        name: crond
        enabled: yes
        state: started

    - name: Ensure boto3 and botocore are installed
      become: yes
      pip:
        name:
          - boto3
          - botocore
        state: present

    - name: Ensure Docker network 'ct' exists
      become: yes
      community.docker.docker_network:
        name: ct
        state: present

    - name: Run PostgreSQL 16 container
      become: yes
      community.docker.docker_container:
        name: postgres16
        image: postgres:16
        state: started
        restart_policy: always
        network_mode: ct
        volumes:
          - postgres16:/var/lib/postgresql/data
        env:
          POSTGRES_HOST_AUTH_METHOD: trust
        shm_size: 512m

    - name: Check if ctdb database exists
      command: docker exec postgres16 psql -U postgres -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname='ctdb'"
      register: ctdb_database_check
      ignore_errors: yes
      changed_when: false

    - name: Import ctdb database from backup
      become: yes
      when: ctdb_database_check.stdout | trim == ''
      block:
        - name: Create ctdb_user role
          command: docker exec -i postgres16 psql -U postgres -d postgres -c "CREATE ROLE ctdb_user LOGIN"
          ignore_errors: yes

        - name: Create ctdb database
          command: docker exec -i postgres16 psql -U postgres -d postgres -c "CREATE DATABASE ctdb OWNER ctdb_user"

        - name: Get latest backup version from S3
          amazon.aws.s3_object:
            bucket: backups.cuetools.net
            object: LATEST
            dest: /tmp/latest_backup.txt
            mode: get

        - name: Set latest backup version fact
          set_fact:
            latest_backup: "{{ lookup('file', '/tmp/latest_backup.txt') | trim }}"

        - name: Download backup from S3
          amazon.aws.s3_object:
            bucket: backups.cuetools.net
            object: "{{ latest_backup }}/ctdb.bin"
            dest: /var/tmp/ctdb.bin
            mode: get

        - name: Restore database
          shell: |
            cat /var/tmp/ctdb.bin | docker exec -i postgres16 pg_restore -U postgres -d ctdb --no-owner
          ignore_errors: yes

        - name: Verify restore succeeded by checking for tables
          command: docker exec postgres16 psql -U postgres -d ctdb -tAc "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public'"
          register: table_count
          failed_when: table_count.stdout | int == 0

        - name: Grant schema permissions
          command: docker exec -i postgres16 psql -U postgres -d ctdb -c "GRANT ALL ON SCHEMA public TO ctdb_user"

        - name: Grant table permissions
          command: docker exec -i postgres16 psql -U postgres -d ctdb -c "GRANT ALL ON ALL TABLES IN SCHEMA public TO ctdb_user"

        - name: Grant sequence permissions
          command: docker exec -i postgres16 psql -U postgres -d ctdb -c "GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO ctdb_user"

        - name: Vacuum database
          command: docker exec -i postgres16 psql -U postgres -d ctdb -c "VACUUM"

        - name: Analyze database
          command: docker exec -i postgres16 psql -U postgres -d ctdb -c "ANALYZE"

    - name: Create /var/run/postgresql directory
      become: yes
      file:
        path: /var/run/postgresql
        state: directory
        mode: '0777'
        owner: root
        group: root

    - name: Run PGBouncer container
      become: yes
      community.docker.docker_container:
        name: pgbouncer
        image: pgbouncer/pgbouncer:latest
        state: started
        restart_policy: always
        networks:
          - name: ct
          - name: musicbrainz-docker_default
        volumes:
          - /var/run/postgresql:/var/run/postgresql
          - /opt/db.cue.tools/utils/docker/pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt
        env:
          DATABASES: "ctwiki = host=postgres16,freedb = host=postgres16,discogs = host=postgres16,musicbrainz = host=musicbrainz-docker-db-1 dbname=musicbrainz_db,ctdb = host=postgres16"
          PGBOUNCER_AUTH_TYPE: trust
          PGBOUNCER_AUTH_FILE: /etc/pgbouncer/userlist.txt
          PGBOUNCER_UNIX_SOCKET_DIR: /var/run/postgresql
          PGBOUNCER_LOG_CONNECTIONS: "0"
          PGBOUNCER_LOG_DISCONNECTIONS: "0"
        # PGBOUNCER_LISTEN_PORT: 6544

    - name: Check if Certbot certificate exists
      stat:
        path: /etc/letsencrypt/live/cue.tools/cert.pem
      register: certbot_cert

    - name: Run Certbot container
      become: yes
      community.docker.docker_container:
        name: certbot
        image: certbot/dns-route53:latest
        state: started
        restart_policy: always
        volumes:
          - /etc/letsencrypt:/etc/letsencrypt
          - /var/lib/letsencrypt:/var/lib/letsencrypt
        command: certonly --dns-route53 --agree-tos --domains cue.tools,db.cue.tools,www.cue.tools -n
      when: not certbot_cert.stat.exists

    - name: Fetch http password file from AWS Secrets Manager
      become: yes
      copy:
        content: "{{ lookup('amazon.aws.aws_secret', 'htpasswd-logspout', region='us-east-1') }}"
        dest: /var/tmp/htpasswd-logspout
        mode: '0644'
        owner: root
        group: root

    - name: Run apache2 reverse proxy container
      become: yes
      community.docker.docker_container:
        name: proxy
        image: httpd:2.4
        state: started
        restart_policy: always
        network_mode: ct
        volumes:
          - /etc/letsencrypt:/etc/letsencrypt
          - /opt/db.cue.tools/utils/docker/proxy/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
          - /var/tmp/htpasswd-logspout:/usr/local/apache2/conf/htpasswd-logspout:ro
          - /opt/db.cue.tools/utils/docker/proxy/htdocs/:/usr/local/apache2/htdocs/:ro
        ports:
          - "80:80"
          - "443:443"

    - name: Run Adminer container
      become: yes
      community.docker.docker_container:
        name: adminer
        image: adminer:latest
        state: started
        restart_policy: always
        network_mode: ct
        volumes:
          - /var/run/postgresql:/var/run/postgresql
          - /opt/db.cue.tools/utils/docker/adminer/login-otp.php:/var/www/html/plugins-enabled/login-otp.php:ro
        env:
          ADMINER_DEFAULT_SERVER: "/var/run/postgresql/:6432"
          ADMINER_OTP_SECRET: "{{ lookup('amazon.aws.aws_secret', 'adminer_otp_secret', region='us-east-1') | from_json | json_query('ADMINER_OTP_SECRET_BASE64') }}"
      no_log: true

    - name: Install Docker Compose
      become: yes
      block:
        - name: Check Docker Compose version
          command: docker-compose --version
          register: docker_compose_check
          failed_when: false
          changed_when: false

        - name: Install Docker Compose if not present
          when: docker_compose_check.rc != 0
          block:
            - name: Determine system architecture
              ansible.builtin.setup:
                filter: ansible_architecture

            - name: Set Docker Compose download URL
              set_fact:
                compose_arch: "{{ 'aarch64' if ansible_architecture == 'aarch64' else 'x86_64' }}"
                compose_url: "https://github.com/docker/compose/releases/latest/download/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}"

            - name: Download Docker Compose
              ansible.builtin.get_url:
                url: "{{ compose_url }}"
                dest: /usr/local/bin/docker-compose
                mode: '0755'

        - name: Verify Docker Compose installation
          command: docker-compose --version
          changed_when: false

    - name: Build a container image for the CTDB database
      become: yes
      community.docker.docker_image:
        name: ctdbweb
        tag: latest
        source: build
        state: present
        build:
          path: /opt/db.cue.tools/utils/docker/ctdbweb
          dockerfile: Dockerfile

    - name: Run CTDB database container
      become: yes
      community.docker.docker_container:
        name: ctdbweb
        image: ctdbweb:latest
        state: started
        restart_policy: always
        network_mode: ct
        volumes:
          - ctparity:/var/www/html/parity
          - /var/run/postgresql:/var/run/postgresql
          - /opt/db.cue.tools/utils/docker/ctdbweb/php.ini:/usr/local/etc/php/php.ini:ro

    - name: Run CTDB Web Dev container
      become: yes
      community.docker.docker_container:
        name: ctdbweb-dev
        image: php:8.4-apache
        state: started
        restart_policy: unless-stopped
        network_mode: ct
        volumes:
          - /opt/db.cue.tools/utils/docker/ctdbweb/db.cue.tools:/var/www/html:rw
          - /opt/db.cue.tools/utils/docker/ctdbweb/ctdbcfg-dev.php:/var/www/html/ctdbcfg.php:ro
          - ctparity-dev:/var/www/html/parity
          - /var/run/postgresql:/var/run/postgresql
          - /opt/db.cue.tools/utils/docker/ctdbweb/php.ini:/usr/local/etc/php/php.ini:ro
          - /opt/db.cue.tools/utils/docker/ctdbweb/remoteip.conf:/etc/apache2/conf-available/remoteip.conf:ro
        command: |
          bash -c "apt-get update &&
                   apt-get install -y postgresql-client libpq-dev libzip-dev &&
                   docker-php-ext-configure pgsql &&
                   docker-php-ext-install -j$(nproc) pgsql zip &&
                   a2enmod remoteip &&
                   a2enconf remoteip &&
                   apache2-foreground"

    # - name: Build a container image for the s3uploader
    #   become: yes
    #   community.docker.docker_image:
    #     name: s3uploader
    #     tag: latest
    #     source: build
    #     state: present
    #     build:
    #       path: /opt/db.cue.tools/utils/s3uploader
    #       dockerfile: Dockerfile

    # - name: Run s3uploader container
    #   become: yes
    #   community.docker.docker_container:
    #     name: s3uploader
    #     image: s3uploader:latest
    #     state: present
    #     restart_policy: no
    #     network_mode: ct
    #     volumes:
    #       - ctparity:/var/www/html/parity
    #       - /var/run/postgresql:/var/run/postgresql

    - name: Build MediaWiki container image
      become: yes
      community.docker.docker_image:
        name: ctwiki
        tag: latest
        source: build
        state: present
        build:
          path: /opt/db.cue.tools/utils/docker/mediawiki
          dockerfile: Dockerfile

    - name: Run MediaWiki container
      become: yes
      community.docker.docker_container:
        name: ctwiki
        image: ctwiki:latest
        state: started
        restart_policy: always
        network_mode: ct
        volumes:
          - ctwikiimages:/var/www/html/images
          - ctwikiblacklist:/var/www/blacklist
          - /var/run/postgresql:/var/run/postgresql
          - /opt/db.cue.tools/utils/docker/mediawiki/LocalSettings.php:/var/www/html/LocalSettings.php

    - name: Build Sendmail container image
      become: yes
      community.docker.docker_image:
        name: sendmail
        tag: latest
        source: build
        state: present
        build:
          path: /opt/db.cue.tools/utils/docker/sendmail
          dockerfile: Dockerfile

    - name: Run Sendmail container
      become: yes
      community.docker.docker_container:
        name: sendmail
        image: sendmail:latest
        hostname: mail.cue.tools
        state: started
        restart_policy: always
        network_mode: ct
        env:
          AWS_SES_SMTP_USERNAME: "{{ lookup('amazon.aws.aws_secret', 'aws_ses_smtp_credentials', region='us-east-1') | from_json | json_query('AWS_SES_SMTP_USERNAME') }}"
          AWS_SES_SMTP_PASSWORD: "{{ lookup('amazon.aws.aws_secret', 'aws_ses_smtp_credentials', region='us-east-1') | from_json | json_query('AWS_SES_SMTP_PASSWORD') }}"
      no_log: true

    - name: Run Logspout container
      become: yes
      community.docker.docker_container:
        name: logspout
        image: gliderlabs/logspout:latest
        state: started
        restart_policy: always
        network_mode: ct
        env:
          TAIL: "100"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock

    - name: Run React development container
      become: yes
      community.docker.docker_container:
        name: react-dev
        image: node:24-bookworm-slim
        state: started
        restart_policy: unless-stopped
        network_mode: ct
        volumes:
          - /opt/db.cue.tools/ansible/files/react-app:/app:rw
          - react_node_modules:/app/node_modules  # Anonymous volume for deps
        working_dir: /app
        command: sh -c "npm run dev -- --host 0.0.0.0 --port 80"
        # ports:
        #   - "3000:80"
        env:
          CHOKIDAR_USEPOLLING: "true"
          WATCHPACK_POLLING: "true"
          NODE_ENV: "development"

#   - name: Add freedb cron job
  #     ansible.builtin.cron:
  #       name: "freedb"
  #       minute: "51"
  #       hour: "1"
  #       day: "5"
  #       job: "/opt/ctdb/www/ctdbweb/utils/freedb/request_spot.sh >> /var/log/reqspot 2>&1"
  #       user: "root"

    - name: Add hourly stats cron job
      ansible.builtin.cron:
        name: "hourly stats"
        minute: "7"
        job: "/bin/cat /opt/db.cue.tools/utils/hourly_stats.sql | /bin/docker exec -i postgres16 psql -U ctdb_user ctdb >> /var/log/hourly 2>&1"
        user: root

    - name: Add Update MediaWiki blacklist cron job
      ansible.builtin.cron:
        name: "update MediaWiki blacklist"
        minute: "0"
        hour: "3"
        job: "/opt/db.cue.tools/utils/docker/mediawiki/updateBlacklist.sh >> /var/log/updateBlacklist.log 2>&1"
        user: root

    - name: Add discogs cron job
      ansible.builtin.cron:
        name: "discogs"
        minute: "41"
        hour: "1"
        day: "5"
        job: "/opt/db.cue.tools/utils/discogs/request_spot.sh >> /var/log/reqspot 2>&1"
        user: "root"

    - name: Add certbot renewal cron job
      ansible.builtin.cron:
        name: "certbot renew"
        minute: "0"
        hour: "4"
        day: "1"
        job: "/opt/db.cue.tools/utils/certbotrenew.sh >> /var/log/certbot.log 2>&1"
        user: "root"

    - name: Create S3 sync cron job
      ansible.builtin.cron:
        name: "s3 sync"
        minute: "0-59/10"
        job: "/bin/docker exec ctdbweb php /var/www/html/utils/s3.php >> /var/log/s3 2>&1"
        user: "root"
        # state: absent

    - name: Create Backup cron job
      ansible.builtin.cron:
        name: "backup"
        minute: "31"
        hour: "1"
        job: "/opt/db.cue.tools/utils/dobackup.sh >> /var/log/s3b 2>&1"
        user: "root"
        # state: absent

